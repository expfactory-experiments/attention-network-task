if(getRversion() >= "2.15.1")  utils::globalVariables(c('exp_stage','trial_type','correct_response','internal_node_id',
                                                        'text','timing_post_trial','view_history','stimulus','time_elapsed',
                                                        'trial_id','trial_index'))

#' Process Attention Network Test experiment data file
#'
#' \code{process_ant()} processes data files generated by the Attention Network Task experiment
#' (\url{https://expfactory.github.io/attention_network_task.html}).
#'
#'@examples
#'\dontrun{
#'ant <- expand.grid(token = participants$token, time=1:2) %>%
#'  rowwise() %>%
#'  mutate(path=paste('data/', token, '_finished/ant', time, '-results.json', sep='')) %>%
#'  do(., expfactory.attentionnetworktest::process_ant(.$path, .$token, .$time)) %>%
#'}
#' @param ant_file Path to ANT file
#' @param p Participant number
#' @param time Time-point at which participant completed ANT
#' @param json Boolean indicating whether ANT data format is JSON (TRUE) or CSV (FALSE)
#' @keywords expfactory ANT
#' @importFrom utils read.csv
#' @importFrom magrittr %>%
#' @importFrom dplyr filter select mutate
#' @export
#' @return Data frame
process_ant <- function(ant_file, p, time, json=TRUE) {
  if(!file.exists(ant_file)){
    return(data.frame(p=p,t=time, file=ant_file))
  }
  if (json) {
    ant <- expfactory::process_expfactory_experiment(ant_file)
  } else {
    ant <- read.csv(ant_file, header = TRUE)
  }
  ant %>% filter(exp_stage == 'test') %>%
    filter(trial_type == 'poldrack-single-stim') %>%
    filter(! is.na(correct_response)) %>%
    select(-trial_id,-trial_index,-internal_node_id,-text,-timing_post_trial,-view_history,-stimulus,-trial_type,-time_elapsed) %>%
    mutate(p = p) %>%
    # no subject column in expfactory 3.X ant data
    mutate(subject = as.factor(p)) %>%
    mutate(file=ant_file, t=time)
}
